<header class="header">
  <div class="header-left">
    <h1>{{ saludo }} {{ userStore.userName() }}!</h1>
    <p>Aquí tienes un resumen de la actividad de hoy</p>
  </div>
  <div class="header-right">

    <div class="notification-container">
      <div class="notification-bell" #notificationBell (click)="toggleNotifications()">
        <i class="fas fa-bell"></i>
        <span class="notification-badge" *ngIf="notifications.length > 0">{{ notifications.length }}</span>
      </div>

      <div class="notifications-panel" #notificationsPanel *ngIf="showNotifications">
        <div class="notifications-header">
          <h4>Notificaciones</h4>
        </div>
        <div class="notifications-list" *ngIf="notifications.length > 0; else noNotifications">
          <div class="notification-item"
               *ngFor="let notification of notifications"
               (click)="handleNotificationClick(notification)"
               [class.is-clickable]="notification.link">
            <div class="notification-icon" [ngClass]="'icon-' + notification.type">
              <i class="fas" [ngClass]="{'fa-exclamation-triangle': notification.type === 'error', 'fa-wrench': notification.type === 'warning', 'fa-info-circle': notification.type === 'info'}"></i>
            </div>
            <div class="notification-content">
              <p>{{ notification.message }}</p>
              <small>{{ notification.time }}</small>
            </div>
          </div>
        </div>
        <ng-template #noNotifications>
          <div class="empty-notifications">
            <p>No hay notificaciones nuevas</p>
          </div>
        </ng-template>
      </div>
    </div>

    <div class="user-menu-container">
      <div class="user-profile" (click)="toggleUserMenu()">
        <div class="user-avatar">{{ userStore.userName().charAt(0) }}</div>
        <div class="user-info">
          <h4>{{ userStore.userName() }}</h4>
          <p>{{ userStore.isAdmin() ? 'Administrador' : userStore.isTech() ? 'Técnico' : 'Usuario' }}</p>
        </div>
      </div>

      <div class="user-dropdown" *ngIf="showUserMenu">
        <a (click)="logout()" class="dropdown-item">
          <i class="fas fa-sign-out-alt"></i>
          <span>Salir del sistema</span>
        </a>
      </div>
    </div>
  </div>
</header>

<div class="dashboard-content">
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando datos...</p>
    </div>
  </div>

  <div *ngIf="!loading">
    <div class="kpi-grid" *ngIf="kpis">
      <div class="kpi-card disponibles">
        <div class="kpi-header">
          <div class="kpi-content">
            <div class="kpi-value">{{ kpis.disponibles }}</div>
            <div class="kpi-label">Equipos Disponibles</div>
          </div>
          <div class="kpi-icon">
            <i class="fas fa-check-circle"></i>
          </div>
        </div>
      </div>

      <div class="kpi-card prestados">
        <div class="kpi-header">
          <div class="kpi-content">
            <div class="kpi-value">{{ kpis.prestados }}</div>
            <div class="kpi-label">Equipos Prestados</div>
          </div>
          <div class="kpi-icon">
            <i class="fas fa-share-alt"></i>
          </div>
        </div>
      </div>

      <div class="kpi-card atrasados">
        <div class="kpi-header">
          <div class="kpi-content">
            <div class="kpi-value">{{ kpis.atrasos }}</div>
            <div class="kpi-label">Devoluciones Atrasadas</div>
          </div>
          <div class="kpi-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
        </div>
      </div>

      <div class="kpi-card mantenimiento">
        <div class="kpi-header">
          <div class="kpi-content">
            <div class="kpi-value">{{ enMantenimiento }}</div>
            <div class="kpi-label">En Mantenimiento</div>
          </div>
          <div class="kpi-icon">
            <i class="fas fa-wrench"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Préstamos vs Devoluciones</h3>
          <p class="chart-subtitle">Actividad de los últimos 7 días</p>
        </div>
        <div class="chart-container">
          <canvas #barChart></canvas>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-header">
          <h3 class="chart-title">Estado de Equipos</h3>
          <p class="chart-subtitle">Distribución actual</p>
        </div>
        <div class="chart-container">
          <canvas #doughnutChart></canvas>
        </div>
      </div>
    </div>

    <div class="activity-section">
      <div class="activity-header">
        <h3 class="chart-title">Actividad Reciente</h3>
        <a routerLink="/prestamos" class="view-all-link">Ver todo</a>
      </div>

      <div class="activity-list" *ngIf="recentActivity.length > 0; else noActivity">
        <div class="activity-item" *ngFor="let item of recentActivity">
          <div class="activity-icon" [ngClass]="getActivityClass(item.tipo)">
            <i class="fas" [ngClass]="getActivityIcon(item.tipo)"></i>
          </div>
          <div class="activity-info">
            <div class="activity-title">{{ item.descripcion }}</div>
            <div class="activity-time">{{ getRelativeTime(item.fecha) }}</div>
          </div>
          <div class="activity-status">
            <span class="status-badge" [ngClass]="'status-' + item.tipo">
              {{ item.tipo }}
            </span>
          </div>
        </div>
      </div>

      <ng-template #noActivity>
        <div class="empty-state">
          <i class="fas fa-clipboard-list"></i>
          <p>No hay actividad reciente</p>
        </div>
      </ng-template>
    </div>

    <div class="quick-actions-section">
      <h3 class="section-title">Acciones Rápidas</h3>
      <div class="quick-actions-grid">
        <a routerLink="/prestamos" class="quick-action-card">
          <div class="quick-action-icon prestamo">
            <i class="fas fa-plus"></i>
          </div>
          <div class="quick-action-content">
            <h4>Nuevo Préstamo</h4>
            <p>Registrar préstamo de equipo</p>
          </div>
        </a>

        <a routerLink="/prestamos" class="quick-action-card">
          <div class="quick-action-icon devolucion">
            <i class="fas fa-undo"></i>
          </div>
          <div class="quick-action-content">
            <h4>Procesar Devolución</h4>
            <p>Registrar devolución de equipo</p>
          </div>
        </a>

        <a routerLink="/mantenimiento" class="quick-action-card">
          <div class="quick-action-icon mantenimiento">
            <i class="fas fa-wrench"></i>
          </div>
          <div class="quick-action-content">
            <h4>Programar Mantenimiento</h4>
            <p>Agendar mantenimiento preventivo</p>
          </div>
        </a>

        <a routerLink="/equipos" class="quick-action-card">
          <div class="quick-action-icon equipo">
            <i class="fas fa-laptop"></i>
          </div>
          <div class="quick-action-content">
            <h4>Gestionar Equipos</h4>
            <p>Ver y administrar inventario</p>
          </div>
        </a>
      </div>
    </div>
  </div>
</div>
