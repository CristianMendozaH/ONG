<header class="header">
  <div class="header-left">
    <h1>Módulo de Mantenimiento</h1>
    <div class="breadcrumb">
      <a routerLink="/dashboard">Dashboard</a>
      <i class="fas fa-chevron-right"></i>
      <span>Mantenimiento</span>
    </div>
  </div>
</header>

<div class="maintenance-content">
  <div class="main-section">
    <div class="content-header">
      <h2 class="content-title">Gestión de Mantenimientos</h2>
      <button class="btn-schedule" (click)="openMaintenanceModal()">
        <i class="fas fa-plus"></i>
        Programar Mantenimiento
      </button>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number">{{ getCountByStatus('programado') }}</div>
        <div class="stat-label">Programados</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ getCountByStatus('en-proceso') }}</div>
        <div class="stat-label">En Proceso</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ getCountByStatus('completado') }}</div>
        <div class="stat-label">Completados</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">{{ alertsCount }}</div>
        <div class="stat-label">Alertas Activas</div>
      </div>
    </div>

    <div *ngIf="loading" class="loading-state">
      <i class="fas fa-spinner fa-spin"></i> Cargando mantenimientos...
    </div>

    <div *ngIf="!loading && error" class="error-state">
      <i class="fas fa-exclamation-circle"></i>
      {{ error }}
    </div>

    <div class="maintenance-table-container" *ngIf="!loading && !error">
      <div class="table-header">
        <h3 class="table-title">Órdenes de Mantenimiento</h3>
        <div class="table-filters">
          <select class="filter-select" [(ngModel)]="statusFilter" (change)="load()">
            <option value="">Todos los estados</option>
            <option value="programado">Programado</option>
            <option value="en-proceso">En Proceso</option>
            <option value="completado">Completado</option>
          </select>
          <select class="filter-select" [(ngModel)]="typeFilter" (change)="load()">
            <option value="">Todos los tipos</option>
            <option value="preventivo">Preventivo</option>
            <option value="correctivo">Correctivo</option>
            <option value="predictivo">Predictivo</option>
          </select>
        </div>
      </div>

      <table class="maintenance-table">
        <thead>
          <tr>
            <th>ID Orden</th>
            <th>Equipo</th>
            <th>Tipo</th>
            <th>Fecha Programada</th>
            <th>Fecha Realizada</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let m of mantenimientos; trackBy: trackByMaintenanceId">
            <td>{{ m.displayId }}</td>
            <td>
              <div class="equipment-info">
                <div class="equipment-name">{{ m.equipment?.name || 'Equipo no encontrado' }}</div>
                <div class="equipment-code">{{ m.equipment?.code }}</div>
              </div>
            </td>
            <td>
              <span class="type-badge" [ngClass]="'type-' + m.type">{{ m.type | titlecase }}</span>
            </td>
            <td>{{ m.scheduledDate | date:'dd/MM/yyyy' }}</td>
            <td>{{ m.performedDate ? (m.performedDate | date:'dd/MM/yyyy') : '-' }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(m.status)">
                {{ getStatusText(m.status) }}
              </span>
            </td>
            <td>
              <div class="actions-cell">
                <button class="action-btn btn-view" (click)="viewMaintenance(m)">
                  <i class="fas fa-eye"></i> Ver
                </button>

                <button *ngIf="m.status === 'programado'" class="action-btn btn-start" (click)="iniciarMantenimiento(m)">
                  <i class="fas fa-play"></i> Iniciar
                </button>

                <button *ngIf="m.status === 'en-proceso'" class="action-btn btn-complete" (click)="openCompleteModal(m)">
                  <i class="fas fa-check"></i> Completar
                </button>

                <button *ngIf="m.status === 'programado'" class="action-btn btn-edit" (click)="editMaintenance(m)">
                  <i class="fas fa-edit"></i> Editar
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="mantenimientos.length === 0">
            <td colspan="7" class="empty-state">
              <i class="fas fa-inbox"></i>
              <p>No hay mantenimientos{{ statusFilter || typeFilter ? ' que coincidan con los filtros' : '' }}.</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="alerts-panel">
    <div class="alerts-header">
      <h3 class="alerts-title">
        <i class="fas fa-exclamation-triangle" style="color: #EE9D08;"></i>
        Alertas Predictivas
      </h3>
      <p class="alerts-subtitle">Mantenimientos recomendados por el sistema</p>
    </div>

    <div *ngFor="let alerta of alertas" class="alert-card" [ngClass]="alerta.tipo">
      <div class="alert-header">
        <div class="alert-content-wrapper">
          <div class="alert-icon" [ngClass]="'alert-' + alerta.tipo">
            <i class="fas" [ngClass]="{
              'fa-exclamation-circle': alerta.tipo === 'critical',
              'fa-exclamation-triangle': alerta.tipo === 'warning',
              'fa-info-circle': alerta.tipo === 'info'
            }"></i>
          </div>
          <div class="alert-content">
            <div class="alert-title">{{ alerta.titulo }}</div>
            <div class="alert-description">{{ alerta.descripcion }}</div>
          </div>
        </div>
      </div>
      <div class="alert-meta">
        <div class="alert-time">
          <i class="fas fa-clock"></i>
          <span>{{ alerta.meta }}</span>
        </div>
      </div>
    </div>

    <div *ngIf="alertas.length === 0 && !loading" class="alert-card info">
       <div class="alert-content-wrapper">
         <div class="alert-icon alert-info"><i class="fas fa-check-circle"></i></div>
         <div class="alert-content">
           <div class="alert-title">Todo en Orden</div>
           <div class="alert-description">No hay alertas activas en este momento.</div>
         </div>
       </div>
    </div>

  </div>
</div>

<div class="modal-overlay" *ngIf="showModal" (click)="closeModal($event)">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">{{ editingMaintenance ? 'Editar' : 'Programar' }} Mantenimiento</h3>
      <button class="modal-close" (click)="closeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="form" (ngSubmit)="guardarMantenimiento()" class="maintenance-form">
        <div class="form-group">
          <label class="form-label">Equipo</label>
          <select formControlName="equipmentId" class="form-select">
            <option value="">Seleccione un equipo</option>
            <option *ngFor="let e of availableEquipos" [value]="e.id">
              {{ e.code }} — {{ e.name }}
            </option>
          </select>
        </div>

        <div *ngIf="selectedEquipment" class="equipment-details">
          <h4>Información del Equipo</h4>
          <div class="info-row">
            <span class="info-label">Código:</span>
            <span class="info-value">{{ selectedEquipment.code }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Estado actual:</span>
            <span class="info-value">{{ selectedEquipment.status | titlecase }}</span>
          </div>
          <div class="info-row" *ngIf="getLastMaintenanceDate(selectedEquipment.id)">
            <span class="info-label">Último mantenimiento:</span>
            <span class="info-value">{{ getLastMaintenanceDate(selectedEquipment.id) | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Tipo de Mantenimiento</label>
            <select formControlName="type" class="form-select">
              <option value="preventivo">Preventivo</option>
              <option value="correctivo">Correctivo</option>
              <option value="predictivo">Predictivo</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Prioridad</label>
            <select formControlName="priority" class="form-select">
              <option value="baja">Baja</option>
              <option value="media">Media</option>
              <option value="alta">Alta</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Fecha Programada</label>
          <input type="date" formControlName="scheduledDate" class="form-input">
        </div>

        <div class="form-group">
          <label class="form-label">Notas y Observaciones</label>
          <textarea
            formControlName="description"
            class="form-textarea"
            placeholder="Describa el problema o la razón del mantenimiento..."
            rows="4">
          </textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeModal()">Cancelar</button>
      <button
        type="submit"
        class="btn-save"
        [disabled]="form.invalid || saving"
        (click)="guardarMantenimiento()">
        <i class="fas fa-spinner fa-spin" *ngIf="saving"></i>
        <i class="fas fa-save" *ngIf="!saving"></i>
        {{ saving ? 'Guardando...' : (editingMaintenance ? 'Actualizar' : 'Guardar Orden') }}
      </button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal($event)">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Detalles del Mantenimiento</h3>
      <button class="modal-close" (click)="closeDetailsModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" *ngIf="selectedMaintenanceDetails">
      <div class="details-grid">
        <div class="details-section">
          <h4>Información General</h4>
          <p><strong>ID Orden:</strong> {{ selectedMaintenanceDisplayId }}</p>
          <p><strong>Equipo:</strong> {{ selectedMaintenanceDetails.equipment?.name }}</p>
          <p><strong>Código:</strong> {{ selectedMaintenanceDetails.equipment?.code }}</p>
          <p><strong>Tipo:</strong> {{ selectedMaintenanceDetails.type | titlecase }}</p>
          <p><strong>Prioridad:</strong> {{ selectedMaintenanceDetails.priority | titlecase }}</p>
        </div>
        <div class="details-section">
          <h4>Cronograma</h4>
          <p><strong>Fecha programada:</strong> {{ selectedMaintenanceDetails.scheduledDate | date:'fullDate' }}</p>
          <p><strong>Fecha realizada:</strong> {{ selectedMaintenanceDetails.performedDate ? (selectedMaintenanceDetails.performedDate | date:'fullDate') : 'Pendiente' }}</p>
          <p><strong>Estado:</strong>
            <span class="status-badge" [ngClass]="getStatusClass(selectedMaintenanceDetails.status)">
              {{ getStatusText(selectedMaintenanceDetails.status) }}
            </span>
          </p>
          <p><strong>Creado:</strong> {{ selectedMaintenanceDetails.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
      </div>

      <div class="notes-section" *ngIf="selectedMaintenanceDetails.description; else noNotes">
        <h4>Notas y Observaciones</h4>
        <div class="notes-content" [innerHTML]="selectedMaintenanceDetails.description | nl2br"></div>
      </div>
      <ng-template #noNotes>
        <div class="notes-section">
          <h4>Notas y Observaciones</h4>
          <div class="notes-content">
            No se ingresaron notas para este mantenimiento.
          </div>
        </div>
      </ng-template>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeDetailsModal()">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showCompleteModal" (click)="closeCompleteModal($event)">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title">Completar Mantenimiento</h3>
      <button class="modal-close" (click)="closeCompleteModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <form [formGroup]="completeForm" (ngSubmit)="submitCompletion()" class="maintenance-form">
        <div class="form-group">
          <label class="form-label">Fecha de Realización</label>
          <input type="date" formControlName="performedDate" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Notas de Finalización (Opcional)</label>
          <textarea
            formControlName="completionNotes"
            class="form-textarea"
            placeholder="Describa el trabajo realizado, piezas cambiadas, etc."
            rows="4">
          </textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn-cancel" (click)="closeCompleteModal()">Cancelar</button>
      <button
        type="submit"
        class="btn-save"
        [disabled]="completeForm.invalid"
        (click)="submitCompletion()">
        <i class="fas fa-check"></i>
        Marcar como Completado
      </button>
    </div>
  </div>
</div>

<div *ngIf="showNotification"
     class="notification-toast"
     [ngClass]="{ 'is-success': notificationType === 'success', 'is-error': notificationType === 'error' }">
  <i class="fas" [ngClass]="{ 'fa-check-circle': notificationType === 'success', 'fa-exclamation-circle': notificationType === 'error' }"></i>
  <span>{{ notificationMessage }}</span>
</div>
