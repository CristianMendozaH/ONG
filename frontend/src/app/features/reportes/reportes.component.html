<header class="header">
  <div class="header-left">
    <h1>Reportes y Analítica</h1>
    <div class="breadcrumb">
      <a routerLink="/dashboard">Dashboard</a>
      <i class="fas fa-chevron-right"></i>
      <span>Reportes</span>
    </div>
  </div>
</header>

<div *ngIf="hasError" class="error-message">
  <i class="fas fa-exclamation-triangle"></i>
  {{ errorMessage }}
</div>

<div *ngIf="isLoading" class="loading-container">
  <div class="spinner"></div>
  <p>Cargando datos...</p>
</div>

<div class="reports-content" *ngIf="!isLoading">
  <div class="main-section">
    <div class="filters-section">
      <h3 class="filters-section-title">
        <i class="fas fa-filter"></i>
        Filtros de Búsqueda
      </h3>

      <div class="quick-time-filters">
        <label class="filter-label">Filtros Rápidos (Año Actual)</label>
        <div class="filters-section-actions">
            <button class="btn-clear" (click)="aplicarFiltroPeriodo('T1')">T1</button>
            <button class="btn-clear" (click)="aplicarFiltroPeriodo('T2')">T2</button>
            <button class="btn-clear" (click)="aplicarFiltroPeriodo('T3')">T3</button>
            <button class="btn-clear" (click)="aplicarFiltroPeriodo('T4')">T4</button>
            <button class="btn-filter" (click)="aplicarFiltroPeriodo('ANIO_COMPLETO')">Año Completo</button>
        </div>
      </div>
      <hr class="filter-divider">

      <div class="filters-section-grid">
        <div class="filter-group">
          <label class="filter-label">Fecha de Inicio</label>
          <input type="date" class="filter-input" [(ngModel)]="filtros.fechaInicio">
        </div>
        <div class="filter-group">
          <label class="filter-label">Fecha de Fin</label>
          <input type="date" class="filter-input" [(ngModel)]="filtros.fechaFin">
        </div>
        <div class="filter-group">
          <label class="filter-label">Tipo de Reporte</label>
          <select class="filter-select" [(ngModel)]="filtros.tipoReporte" (ngModelChange)="onTipoReporteChange()">
            <option *ngFor="let tipo of tiposReporte" [value]="tipo.value">{{ tipo.label }}</option>
          </select>
        </div>

        <div class="filter-group" *ngIf="filtros.tipoReporte === 'prestamos' || filtros.tipoReporte === 'user_activity' || filtros.tipoReporte === 'equipos_populares'">
            <label class="filter-label">Tipo de Usuario</label>
            <select class="filter-select" [(ngModel)]="filtros.borrowerType">
                <option *ngFor="let tipo of tiposUsuario" [value]="tipo.value">{{ tipo.label }}</option>
            </select>
        </div>

        <div class="filter-group" *ngIf="filtros.tipoReporte === 'prestamos'">
          <label class="filter-label">Estado</label>
          <select class="filter-select" [(ngModel)]="filtros.estado">
            <option *ngFor="let estado of estadosPrestamo" [value]="estado.value">{{ estado.label }}</option>
          </select>
        </div>
      </div>
      <div class="filters-section-actions main-actions">
        <button class="btn-clear" (click)="limpiarFiltros()"><i class="fas fa-times"></i> Limpiar</button>
        <button class="btn-filter" (click)="aplicarFiltros()"><i class="fas fa-search"></i> Buscar</button>
      </div>
    </div>

    <div class="reports-table-container">
      <div class="table-header">
        <h3 class="table-header-title">Resultados del Reporte</h3>
        <div class="export-buttons">
          <button class="btn-export-pdf" (click)="exportarPDF()" [disabled]="reportes.length === 0"><i class="fas fa-file-pdf"></i> PDF</button>
          <button class="btn-export-excel" (click)="exportarExcel()" [disabled]="reportes.length === 0"><i class="fas fa-file-excel"></i> Excel</button>
        </div>
      </div>

      <table class="reports-table">
        <ng-container [ngSwitch]="filtros.tipoReporte">

          <thead *ngSwitchCase="'mantenimiento'">
            <tr>
              <th>ID</th>
              <th>Equipo</th>
              <th>Tipo</th>
              <th>Técnico</th>
              <th>Fecha Realización</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody *ngSwitchCase="'mantenimiento'">
            <tr *ngFor="let reporte of reportes; trackBy: trackByReporte">
              <td>{{ reporte.correlativo | padNumber:3 }}</td>
              <td>{{ reporte.equipo }} ({{ reporte.codigoEquipo }})</td>
              <td>{{ reporte.tipo }}</td>
              <td>{{ reporte.tecnico || '-' }}</td>
              <td>{{ reporte.fechaRealizacion | date:'yyyy-MM-dd' }}</td>
              <td><span class="status-badge" [ngClass]="getEstadoClass(reporte.estado)">{{ reporte.estado }}</span></td>
            </tr>
          </tbody>

          <thead *ngSwitchCase="'equipos_populares'">
            <tr>
              <th>#</th>
              <th>Equipo</th>
              <th>Categoría</th>
              <th>Total de Usos</th>
            </tr>
          </thead>
          <tbody *ngSwitchCase="'equipos_populares'">
            <tr *ngFor="let reporte of reportes; let i = index; trackBy: trackByReporte">
              <td>{{ i + 1 + ((currentPage - 1) * itemsPerPage) }}</td>
              <td>{{ reporte.equipo }}</td>
              <td>{{ reporte.categoria }}</td>
              <td>{{ reporte.total_usos }}</td>
            </tr>
          </tbody>

          <thead *ngSwitchCase="'user_activity'">
            <tr>
              <th>#</th>
              <th>Usuario</th>
              <th>Tipo de Usuario</th>
              <th>Total de Préstamos</th>
            </tr>
          </thead>
          <tbody *ngSwitchCase="'user_activity'">
            <tr *ngFor="let reporte of reportes; let i = index; trackBy: trackByReporte">
              <td>{{ i + 1 + ((currentPage - 1) * itemsPerPage) }}</td>
              <td>{{ reporte.usuario }}</td>
              <td>{{ reporte.tipo_usuario }}</td>
              <td>{{ reporte.total_prestamos }}</td>
            </tr>
          </tbody>

          <thead *ngSwitchDefault>
            <tr>
              <th>ID</th>
              <th>Equipo</th>
              <th>Usuario</th>
              <th>Fecha Préstamo</th>
              <th>Fecha Devolución</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody *ngSwitchDefault>
            <tr *ngFor="let reporte of reportes; trackBy: trackByReporte">
              <td>{{ reporte.correlativo | padNumber:3 }}</td>
              <td>{{ reporte.equipo }}</td>
              <td>{{ reporte.usuario }}</td>
              <td>{{ reporte.fechaPrestamo | date:'yyyy-MM-dd' }}</td>
              <td>{{ reporte.fechaDevolucion ? (reporte.fechaDevolucion | date:'yyyy-MM-dd') : '-' }}</td>
              <td>
                <span class="status-badge" [ngClass]="getEstadoClass(reporte.estado)">{{ reporte.estado }}</span>
              </td>
            </tr>
          </tbody>
        </ng-container>

        <tr *ngIf="!isLoading && (!reportes || reportes.length === 0)">
          <td colspan="7" class="empty-state">
            <i class="fas fa-inbox"></i>
            <p>No se encontraron reportes con los filtros aplicados</p>
          </td>
        </tr>
      </table>

      <div class="pagination" *ngIf="totalItems > itemsPerPage">
        <button class="pagination-btn" [disabled]="currentPage === 1" (click)="cambiarPagina(currentPage - 1)">
          <i class="fas fa-chevron-left"></i>
        </button>
        <span class="pagination-info">Página {{ currentPage }} de {{ totalPages }}</span>
        <button class="pagination-btn" [disabled]="currentPage >= totalPages" (click)="cambiarPagina(currentPage + 1)">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="charts-panel">
    <div class="chart-card">
      <h3 class="chart-card-title"><i class="fas fa-chart-bar"></i> Estadísticas Generales</h3>

      <div *ngIf="filtros.tipoReporte === 'prestamos' || filtros.tipoReporte === 'equipos_populares' || filtros.tipoReporte === 'user_activity'" class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">{{ totalPrestamos }}</div>
          <div class="stat-label">Total Préstamos</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ totalDevueltos }}</div>
          <div class="stat-label">Devueltos</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ totalActivos }}</div>
          <div class="stat-label">Activos</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ totalVencidos }}</div>
          <div class="stat-label">Atrasados</div>
        </div>
      </div>

      <div *ngIf="filtros.tipoReporte === 'mantenimiento'" class="stats-grid">
        <div class="stat-item">
          <div class="stat-number">{{ totalMantenimientos }}</div>
          <div class="stat-label">Total Mantenimientos</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ mantenimientosProgramados }}</div>
          <div class="stat-label">Programados</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ mantenimientosEnProceso }}</div>
          <div class="stat-label">En Proceso</div>
        </div>
        <div class="stat-item">
          <div class="stat-number">{{ mantenimientosCompletados }}</div>
          <div class="stat-label">Completados</div>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <h3 class="chart-card-title"><i class="fas fa-chart-pie"></i> Distribución por Estado</h3>
      <div *ngIf="filtros.tipoReporte === 'prestamos' || filtros.tipoReporte === 'equipos_populares' || filtros.tipoReporte === 'user_activity'" class="status-distribution">
        <div class="status-item">
          <div class="status-color status-active"></div>
          <span>Activos: {{ totalActivos }}</span>
        </div>
        <div class="status-item">
          <div class="status-color status-returned"></div>
          <span>Devueltos: {{ totalDevueltos }}</span>
        </div>
        <div class="status-item">
          <div class="status-color status-overdue"></div>
          <span>Atrasados: {{ totalVencidos }}</span>
        </div>
      </div>

      <div *ngIf="filtros.tipoReporte === 'mantenimiento'" class="status-distribution">
          <div class="status-item">
            <div class="status-color status-returned"></div>
            <span>Programados: {{ mantenimientosProgramados }}</span>
          </div>
          <div class="status-item">
            <div class="status-color status-active"></div>
            <span>En Proceso: {{ mantenimientosEnProceso }}</span>
          </div>
          <div class="status-item">
            <div class="status-color status-returned"></div>
            <span>Completados: {{ mantenimientosCompletados }}</span>
          </div>
      </div>
    </div>

    <div class="chart-card">
      <h3 class="chart-card-title"><i class="fas fa-tools"></i> Acciones Rápidas</h3>
      <div class="quick-actions">
        <button class="quick-action-btn" (click)="refrescarDatos()"><i class="fas fa-sync"></i> Refrescar Datos</button>
        <button class="quick-action-btn" (click)="limpiarFiltros()"><i class="fas fa-eraser"></i> Limpiar Filtros</button>
      </div>
    </div>
  </div>
</div>
